<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الاختبار النفسي</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@700&display=swap" rel="stylesheet">
    <style>
        /* Header Styles */
        .top-header-bar {
            width: 100vw;
            background: #db1779;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 0 2.5vw;
            box-sizing: border-box;
            position: fixed;
            top: 0;
            right: 0;
            left: 0;
            z-index: 2000;
        }
        .header-logo {
            display: flex;
            align-items: center;
            gap: 0.7em;
            margin-right: 0;
            margin-left: auto;
        }
        .header-logo img {
            height: 40px;
            width: auto;
            object-fit: contain;
            border-radius: 8px;
            background: #db1779;
            box-shadow: 0 1px 4px #db17793a;
        }

        /* Back Button Styles */
        .back-button {
            background: #f7a4c6;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            box-shadow: 0 2px 8px #db17791a;
            margin-right: 0.5rem;
            margin-left: 0;
            font-size: 1.5rem;
        }
        .back-button:hover {
            background: #f08db8;
            transform: translateX(3px);
        }
        .back-button::before {
            content: "←";
            font-size: 1.5rem;
            line-height: 1;
        }

        /* Question Container Styles */
        .question-container {
            background: #fff;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px #db17791a;
            transition: all 0.3s ease;
        }
        .question-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px #db17793a;
        }
        .question-container h3 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }
        .options-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .option-item {
            margin-bottom: 0.8rem;
        }
        .option-label {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.8rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .option-label:hover {
            background: #f8e1ed;
        }
        .option-input {
            accent-color: #db1779;
        }

        /* Submit Button Styles */
        .submit-container {
            position: static;
            width: 100%;
            display: flex;
            justify-content: center;
            margin: 2.5rem 0 0 0;
        }
        .start-test-btn {
            display: block;
            width: 90%;
            max-width: 420px;
            padding: 1.1rem 0;
            background: #db1779;
            color: #fff;
            border: none;
            border-radius: 18px;
            font-size: 1.25rem;
            font-weight: bold;
            cursor: pointer;
            margin: 0 auto;
            transition: background 0.2s, box-shadow 0.2s, transform 0.15s;
            box-shadow: 0 2px 8px #db17791a;
        }
        .start-test-btn:hover {
            background: #b3145f;
            box-shadow: 0 4px 16px #db17793a;
            transform: scale(1.03);
        }

        /* Responsive Styles */
        @media (max-width: 600px) {
            .top-header-bar {
                min-height: 48px;
                padding: 0 1vw;
            }
            .header-logo img {
                height: 32px;
            }
            .back-button {
                width: 32px;
                height: 32px;
            }
            .back-button::before {
                font-size: 1rem;
            }
            .question-container {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            .question-container h3 {
                font-size: 1.1rem;
            }
            .option-label {
                padding: 0.6rem;
            }
            .start-test-btn {
                padding: 0.5rem 1.2rem;
                font-size: 0.9rem;
            }
            .submit-container {
                bottom: 15px;
                left: 15px;
            }
        }

        /* Main Container Styles */
        .container {
            max-width: 800px;
            margin: 80px auto 40px;
            padding: 0 1rem;
            padding-bottom: 80px; /* Add space for fixed submit button */
        }
        body {
            background: #f4f5f8;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
    </style>
</head>
<body>
    <div id="alert" class="alert" style="display:none; text-align:left; left: 0; right: auto; position: fixed; top: 80px; max-width: 350px; z-index: 9999;"></div>
    <div class="top-header-bar">
        <a href="index.html" class="back-button" title="العودة للرئيسية"></a>
        <div class="header-logo">
            <img src="img\Screenshot 2025-05-20 125810.png" alt="شعار الموقع" />
        </div>
    </div>
    
    <div class="container">
        <div id="testContainer">
            <!-- Test content will be loaded here -->
        </div>
    </div>

    <!-- Email Modal -->
    <div id="emailModal" class="modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:#0007;z-index:3000;align-items:center;justify-content:center;">
        <div style="background:#fff;padding:2.2rem 1.5rem 1.5rem 1.5rem;border-radius:18px;box-shadow:0 4px 32px #db17793a;max-width:95vw;width:350px;display:flex;flex-direction:column;align-items:center;">
            <h3 style="color:#db1779;margin-bottom:1.2rem;">يرجى إدخال بريدك الإلكتروني</h3>
            <form id="emailForm">
                <input id="userEmail" type="email" placeholder="example@email.com" style="width:100%;padding:0.7rem 1rem;border-radius:8px;border:1.5px solid #db1779;font-size:1.1rem;margin-bottom:1.1rem;direction:ltr;text-align:left;" required>
                <div id="emailError" style="color:#d32f2f;font-size:1rem;display:none;margin-bottom:0.7rem;text-align:center;"></div>
                <button type="submit" style="background:#db1779;color:#fff;border:none;border-radius:8px;padding:0.7rem 2.2rem;font-size:1.1rem;font-weight:600;cursor:pointer;">متابعة</button>
            </form>
        </div>
    </div>

    <!-- Results Modal -->
    <div id="resultsModal" class="modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:#0007;z-index:3000;align-items:center;justify-content:center;">
        <div style="background:#fff;padding:2.2rem 1.5rem 1.5rem 1.5rem;border-radius:18px;box-shadow:0 4px 32px #db17793a;max-width:95vw;width:350px;display:flex;flex-direction:column;align-items:center;">
            <h3 style="color:#db1779;margin-bottom:1.2rem;">نتائج الاختبار</h3>
            <div id="resultsContent"></div>
            <button onclick="window.location.href='index.html'" style="background:#db1779;color:#fff;border:none;border-radius:8px;padding:0.7rem 2.2rem;font-size:1.1rem;font-weight:600;cursor:pointer;margin-top:1rem;">العودة للرئيسية</button>
        </div>
    </div>

    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBbBGHRDene0SLHi_9-JghZSREZN_xftpc",
            authDomain: "phys-quizzes.firebaseapp.com",
            projectId: "phys-quizzes",
            storageBucket: "phys-quizzes.firebasestorage.app",
            messagingSenderId: "462871719829",
            appId: "1:462871719829:web:2833caf94cfc5fb0b1d09c",
            measurementId: "G-MCST1ZCND7",
            databaseURL: "https://phys-quizzes-default-rtdb.firebaseio.com"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();
        const analytics = firebase.analytics();

        // Get test ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const testId = urlParams.get('id');

        // DOM Elements
        const testContainer = document.getElementById('testContainer');
        const emailModal = document.getElementById('emailModal');
        const resultsModal = document.getElementById('resultsModal');
        const emailForm = document.getElementById('emailForm');
        const resultsContent = document.getElementById('resultsContent');

        // State
        let currentTest = null;
        let userAnswers = {};

        // Load Test
        function loadTest() {
            if (!testId) {
                testContainer.innerHTML = '<p style="text-align: center; color: #db1779;">لم يتم تحديد اختبار</p>';
                return;
            }

            // Show loading state
            testContainer.innerHTML = '<p style="text-align: center;">جاري تحميل الاختبار...</p>';

            // Get test data
            const testRef = database.ref('tests/' + testId);
            
            testRef.once('value')
                .then(function(snapshot) {
                    const testData = snapshot.val();
                    console.log('Test data:', testData); // Debug log
                    
                    if (!testData) {
                        testContainer.innerHTML = '<p style="text-align: center; color: #db1779;">الاختبار غير موجود</p>';
                        return;
                    }

                    currentTest = {
                        id: testId,
                        ...testData
                    };

                    if (!currentTest.questions || !Array.isArray(currentTest.questions)) {
                        console.error('Invalid questions data:', currentTest.questions); // Debug log
                        testContainer.innerHTML = '<p style="text-align: center; color: #db1779;">لا توجد أسئلة في هذا الاختبار</p>';
                        return;
                    }

                    console.log('Current test:', currentTest); // Debug log
                    renderTest();
                })
                .catch(function(error) {
                    console.error('Error loading test:', error);
                    testContainer.innerHTML = '<p style="text-align: center; color: #db1779;">حدث خطأ أثناء تحميل الاختبار</p>';
                });
        }

        // Render Test
        function renderTest() {
            console.log('Rendering test:', currentTest); // Debug log

            let html = `
                <div class="test-header">
                    <h1>${currentTest.title || 'الاختبار'}</h1>
                    <p>${currentTest.description || ''}</p>
                </div>
                <form id="testForm">
            `;

            // Add questions
            currentTest.questions.forEach((question, index) => {
                console.log('Processing question:', question); // Debug log

                if (!question || !question.text) {
                    console.warn('Invalid question:', question); // Debug log
                    return;
                }

                // Use 'answers' array if present, otherwise fallback to 'options'
                let options = (question.answers && Array.isArray(question.answers) && question.answers.length > 0)
                    ? question.answers
                    : (question.options && Array.isArray(question.options) && question.options.length > 0)
                        ? question.options
                        : [];

                console.log(`Options for question ${index + 1}:`, options); // Debug log

                html += `
                    <div class="question-container">
                        <h3>السؤال ${index + 1}</h3>
                        <p>${question.text}</p>
                        <ul class="options-list">
                `;

                // Add options
                options.forEach((option, optIndex) => {
                    if (!option) {
                        console.warn('Invalid option:', option); // Debug log
                        return;
                    }
                    html += `
                        <li class="option-item">
                            <label class="option-label">
                                <input type="radio" name="q${index}" value="${optIndex}" required class="option-input">
                                <span>${option}</span>
                            </label>
                        </li>
                    `;
                });

                html += `
                        </ul>
                    </div>
                `;
            });

            html += `
                    <div class="submit-container">
                        <button type="submit" class="start-test-btn">إنهاء الاختبار</button>
                    </div>
                </form>
            `;

            testContainer.innerHTML = html;

            // Add form submit handler
            document.getElementById('testForm').addEventListener('submit', handleTestSubmit);
        }

        // Handle Test Submit
        function handleTestSubmit(e) {
            e.preventDefault();
            
            // Collect answers
            const formData = new FormData(e.target);
            userAnswers = {};
            for (let [key, value] of formData.entries()) {
                userAnswers[key] = parseInt(value);
            }

            console.log('User answers:', userAnswers); // Debug log

            // Validate that all questions are answered
            const allQuestionsAnswered = currentTest.questions.every((_, index) => {
                return userAnswers[`q${index}`] !== undefined;
            });

            if (!allQuestionsAnswered) {
                alert('يرجى الإجابة على جميع الأسئلة');
                return;
            }

            // Show email modal
            emailModal.style.display = 'flex';
        }

        // Handle Email Submit
        emailForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('userEmail').value;

            // Calculate score
            const score = calculateScore(userAnswers);
            
            // Save results
            database.ref('results').push({
                testId: testId,
                email: email,
                score: score,
                answers: userAnswers,
                timestamp: Date.now()
            })
            .then(function() {
                // Show results
                showResults(score);
            })
            .catch(function(error) {
                console.error('Error saving results:', error);
                document.getElementById('emailError').textContent = 'حدث خطأ أثناء حفظ النتائج';
                document.getElementById('emailError').style.display = 'block';
            });
        });

        // Calculate Score
        function calculateScore(answers) {
            let totalScore = 0;
            Object.entries(answers).forEach(([questionKey, answerIndex]) => {
                const questionIndex = parseInt(questionKey.replace('q', ''));
                const question = currentTest.questions[questionIndex];
                if (question && question.scores && question.scores[answerIndex]) {
                    totalScore += question.scores[answerIndex];
                }
            });
            return totalScore;
        }

        // Show Results
        function showResults(score) {
            emailModal.style.display = 'none';
            resultsContent.innerHTML = `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <h4 style="color: #db1779; margin-bottom: 0.5rem;">النتيجة النهائية</h4>
                    <div style="font-size: 2rem; font-weight: bold; color: #333;">${score}</div>
                </div>
                <p style="text-align: center; color: #666;">${getFeedback(score)}</p>
            `;
            resultsModal.style.display = 'flex';
        }

        // Get Feedback
        function getFeedback(score) {
            if (currentTest.feedback && Array.isArray(currentTest.feedback)) {
                for (const range of currentTest.feedback) {
                    if (score >= range.min && score <= range.max) {
                        return range.text;
                    }
                }
            }
            return 'شكراً لإكمال الاختبار!';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', loadTest);
    </script>
</body>
</html> 