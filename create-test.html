<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="صفحة إنشاء اختبار نفسي جديد">
    <title>إضافة اختبار جديد</title>
    <style>
        :root {
            --primary: #db1779;
            --primary-light: #f8e1ed;
            --background: #f8f9fb;
            --card: #fff;
            --shadow: 0 2px 8px rgba(219,23,121,0.07);
            --border-radius: 16px;
            --text: #333;
            --error: #dc3545;
            --success: #28a745;
        }

        /* Reset and Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--background);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text);
            direction: rtl;
            line-height: 1.6;
        }

        /* Layout Components */
        .container {
            max-width: 800px;
            margin: 80px auto 40px;
            background: var(--card);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 2.5rem 2rem;
        }

        .top-header-bar {
            width: 100vw;
            background: var(--primary);
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 0 2.5vw;
            box-sizing: border-box;
            position: fixed;
            top: 0;
            right: 0;
            left: 0;
            z-index: 2000;
        }

        /* Typography */
        h1 {
            color: var(--primary);
            margin-bottom: 2rem;
            text-align: center;
            font-size: 2rem;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: block;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 0.7rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            margin-top: 0.3rem;
            background: #fafafa;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--primary-light);
        }

        /* Image Upload */
        .img-upload-container {
            position: relative;
            margin-top: 1rem;
        }

        input[type="file"] {
            width: 100%;
            padding: 0.5rem;
            border: 2px dashed #ddd;
            border-radius: 8px;
            cursor: pointer;
        }

        .img-preview {
            display: block;
            margin: 1rem auto 0.5rem;
            max-width: 180px;
            max-height: 120px;
            border-radius: 10px;
            box-shadow: 0 1px 4px #db17793a;
            object-fit: cover;
            background: var(--primary-light);
        }

        /* Questions Section */
        .questions-section {
            margin-top: 2rem;
            background: #fff;
            border-radius: 12px;
            padding: 1.5rem 1rem;
            box-shadow: 0 1px 4px #db17791a;
        }

        .question-block {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 1px 8px #db17791a;
            margin-bottom: 1.5rem;
            padding: 1.2rem 1rem;
            border: 1px solid #f0e0ef;
        }

        .answers-row {
            display: flex;
            gap: 1rem;
            margin-top: 0.7rem;
            flex-wrap: wrap;
        }

        .answer-col {
            flex: 1 1 180px;
            min-width: 120px;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        /* Score Conditions */
        .score-condition-row {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 0.7rem;
        }

        .score-condition-row input[type="number"] {
            width: 80px;
        }

        .score-condition-row input[type="text"] {
            flex: 1;
        }

        /* Buttons */
        .btn {
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 0.9rem 2.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            display: inline-block;
            text-align: center;
        }

        .btn:hover {
            background: #b3145f;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: #fff0f6;
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .btn-secondary:hover {
            background: var(--primary);
            color: #fff;
        }

        .btn-full {
            width: 100%;
            margin-top: 1.5rem;
        }

        /* Alerts */
        .alert {
            background: #fff0f6;
            color: var(--primary);
            border: 1px solid var(--primary);
            border-radius: 8px;
            padding: 0.7rem 1rem;
            margin-bottom: 1.2rem;
            text-align: center;
            font-size: 1rem;
            display: none;
        }

        .alert.success {
            background: #e6fffa;
            color: var(--success);
            border-color: var(--success);
        }

        .alert.error {
            background: #fff0f6;
            color: var(--error);
            border-color: var(--error);
        }

        /* Responsive Design */
        @media (max-width: 600px) {
            .container {
                padding: 1rem;
                margin-top: 60px;
            }

            .top-header-bar {
                min-height: 48px;
                padding: 0 1vw;
            }

            .header-logo img {
                height: 32px;
            }

            .answers-row {
                flex-direction: column;
                gap: 0.5rem;
            }

            .btn {
                padding: 0.7rem 1.5rem;
                font-size: 1rem;
            }
        }

        /* Accessibility */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        /* Loading States */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 1em;
            height: 1em;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header class="top-header-bar" style="display: flex; align-items: center; justify-content: space-between; padding: 0 1vw; background: #db1779; min-height: 40px; height: 48px; box-shadow: 0 2px 8px #db17791a;">
        <div class="header-logo" style="display: flex; align-items: center; gap: 0.5em;">
            <img src="img/Screenshot 2025-05-20 125810.png" alt="شعار الموقع" style="height: 28px; width: auto; border-radius: 6px; background: #db1779; box-shadow: 0 1px 4px #db17793a;">
        </div>
        <div style="width: 28px;"></div>
    </header>

    <main class="container" role="main">
        <h1>إضافة اختبار نفسي جديد</h1>
        <div id="alert" class="alert" role="alert" aria-live="polite"></div>

        <form id="testForm" onsubmit="return false;" autocomplete="off" novalidate>
            <div class="form-group">
                <label for="testTitle">عنوان الاختبار</label>
                <input type="text" id="testTitle" required
                       aria-required="true"
                       aria-describedby="titleError">
                <div id="titleError" class="error-message visually-hidden"></div>
            </div>

            <div class="form-group">
                <label for="testType">نوع الاختبار</label>
                <select id="testType" required aria-required="true">
                    <option value="free">مجاني</option>
                    <option value="paid">مدفوع</option>
                </select>
            </div>

            <div class="form-group">
                <label for="testImage">إضافة صورة للاختبار</label>
                <div class="img-upload-container">
                    <input type="file" id="testImage" accept="image/*" required
                           aria-required="true"
                           aria-describedby="imageError">
                    <img id="imgPreview" class="img-preview" style="display:none;" 
                         alt="معاينة صورة الاختبار" />
                    <div id="imageError" class="error-message visually-hidden"></div>
                </div>
            </div>

            <div class="form-group">
                <label for="questionCount">عدد الأسئلة</label>
                <input type="number" id="questionCount" min="1" required
                       aria-required="true"
                       aria-describedby="countError">
                <div id="countError" class="error-message visually-hidden"></div>
                <button type="button" id="generateQuestionsBtn" class="btn">
                    إنشاء الأسئلة
                </button>
            </div>

            <div id="questionsSection" class="questions-section" aria-live="polite"></div>

            <div id="scoreConditionsBox" class="questions-section">
                <h3>شروط الرسائل حسب الدرجة</h3>
                <div id="scoreConditionsList"></div>
                <button type="button" id="addScoreConditionBtn" class="btn btn-secondary">
                    إضافة شرط جديد
                </button>
            </div>

            <button type="button" id="saveTestBtn" class="btn btn-full">
                حفظ الاختبار
            </button>
        </form>
    </main>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-analytics-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="js/firebase-config.js"></script>

    <script>
        // Constants
        const MAX_QUESTIONS = 50;
        const MAX_ANSWERS = 4;
        const MAX_IMAGE_SIZE = 5 * 1024 * 1024; // 5MB
        const ALLOWED_IMAGE_TYPES = ['image/jpeg', 'image/png', 'image/gif'];

        // State management
        let currentTest = null;
        let isEditing = false;
        let formValidationState = {
            title: false,
            image: false,
            questions: false
        };

        // Initialize Firebase and set up event listeners
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Initialize Firebase
                await window.firebaseDB.initialize();
                console.log('Firebase initialized successfully');

                // Set up event listeners
                setupEventListeners();

                // Check if we're editing an existing test
                const testId = new URLSearchParams(window.location.search).get('id');
                if (testId) {
                    await loadExistingTest(testId);
                }
            } catch (error) {
                console.error('Failed to initialize Firebase:', error);
                showAlert('حدث خطأ في الاتصال بقاعدة البيانات', 'error');
            }
        });

        // Set up all event listeners
        function setupEventListeners() {
            document.getElementById('generateQuestionsBtn').addEventListener('click', generateQuestions);
            document.getElementById('addScoreConditionBtn').addEventListener('click', addScoreCondition);
            document.getElementById('saveTestBtn').addEventListener('click', handleSaveTest);
            document.getElementById('testImage').addEventListener('change', handleImageUpload);
        }

        // Generate questions based on count
        function generateQuestions() {
            const count = parseInt(document.getElementById('questionCount').value);
            const errorDiv = document.getElementById('countError');
            
            if (isNaN(count) || count < 1) {
                errorDiv.textContent = 'الرجاء إدخال عدد صحيح من الأسئلة';
                errorDiv.classList.remove('visually-hidden');
                return;
            }
            if (count > MAX_QUESTIONS) {
                errorDiv.textContent = `الحد الأقصى للأسئلة هو ${MAX_QUESTIONS}`;
                errorDiv.classList.remove('visually-hidden');
                return;
            }

            const questionsSection = document.getElementById('questionsSection');
            questionsSection.innerHTML = '';
            
            for (let i = 0; i < count; i++) {
                const qId = `questionType${i}`;
                let html = `
                    <div class="question-block">
                        <div class="form-group">
                            <label for="question${i}">السؤال ${i + 1}</label>
                            <input type="text" id="question${i}" class="question-text" placeholder="أدخل نص السؤال" required>
                        </div>
                        <div class="form-group">
                            <label for="${qId}">نوع السؤال</label>
                            <select id="${qId}" class="question-type">
                                <option value="multiple">اختيار من متعدد</option>
                                <option value="truefalse">صح أو خطأ</option>
                            </select>
                        </div>
                        <div class="answers-row" id="answersRow${i}"></div>
                    </div>
                `;
                questionsSection.innerHTML += html;
                setTimeout(() => renderAnswers(i, 'multiple'), 0);
            }

            // Add event listeners for question type changes
            document.querySelectorAll('.question-type').forEach((sel, idx) => {
                sel.addEventListener('change', e => renderAnswers(idx, e.target.value));
            });
        }

        // Render answers based on question type
        function renderAnswers(qIndex, type) {
            const answersRow = document.getElementById('answersRow' + qIndex);
            answersRow.innerHTML = '';
            let options = type === 'multiple' ? ['', '', '', ''] : ['', ''];
            
            options.forEach((label, j) => {
                answersRow.innerHTML += `
                    <div class="answer-col">
                        <input type="text" class="answer-text" placeholder="الإجابة ${j + 1}" required>
                        <input type="number" class="answer-score" min="0" max="3" value="0" style="width:50px;" required>
                        <label>نقاط</label>
                    </div>
                `;
            });
        }

        // Add score condition
        function addScoreCondition() {
            const conditionsList = document.getElementById('scoreConditionsList');
            const conditionDiv = document.createElement('div');
            conditionDiv.className = 'score-condition-row';
            conditionDiv.innerHTML = `
                <input type="number" placeholder="من" min="0" required style="width:70px;">
                <input type="number" placeholder="إلى" min="0" required style="width:70px;">
                <input type="text" placeholder="الرسالة" required>
                <button type="button" class="btn btn-secondary" onclick="this.parentElement.remove()">حذف</button>
            `;
            conditionsList.appendChild(conditionDiv);
        }

        // Handle image upload
        function handleImageUpload(event) {
            const file = event.target.files[0];
            const errorDiv = document.getElementById('imageError');
            
            if (!file) {
                errorDiv.textContent = 'الرجاء اختيار صورة';
                errorDiv.classList.remove('visually-hidden');
                return;
            }

            if (!ALLOWED_IMAGE_TYPES.includes(file.type)) {
                errorDiv.textContent = 'نوع الملف غير مدعوم. الرجاء اختيار صورة (JPEG, PNG, GIF)';
                errorDiv.classList.remove('visually-hidden');
                return;
            }

            if (file.size > MAX_IMAGE_SIZE) {
                errorDiv.textContent = 'حجم الصورة كبير جداً. الحد الأقصى هو 5 ميجابايت';
                errorDiv.classList.remove('visually-hidden');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const imgPreview = document.getElementById('imgPreview');
                imgPreview.src = e.target.result;
                imgPreview.style.display = 'block';
                errorDiv.classList.add('visually-hidden');
                formValidationState.image = true;
            };
            reader.readAsDataURL(file);
        }

        // Load existing test
        async function loadExistingTest(testId) {
            try {
                const testData = await window.firebaseDB.getData(`tests/${testId}`);
                if (testData) {
                    isEditing = true;
                    currentTest = testData;
                    
                    // Fill form with test data
                    document.getElementById('testTitle').value = testData.title || '';
                    document.getElementById('testType').value = testData.isFree ? 'free' : 'paid';
                    
                    if (testData.image) {
                        document.getElementById('imgPreview').src = testData.image;
                        document.getElementById('imgPreview').style.display = 'block';
                        formValidationState.image = true;
                    }
                    
                    // Add questions
                    if (testData.questions && Array.isArray(testData.questions)) {
                        testData.questions.forEach((question, index) => {
                            addQuestionToUI(question, index);
                        });
                    }
                    
                    // Add score conditions
                    if (testData.results && Object.keys(testData.results).length > 0) {
                        Object.entries(testData.results).forEach(([key, message]) => {
                            addScoreConditionToUI({ min: parseInt(key.split('-')[0]), max: parseInt(key.split('-')[1]), message });
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading test:', error);
                showAlert('حدث خطأ في تحميل بيانات الاختبار', 'error');
            }
        }

        // Save test
        async function handleSaveTest() {
            try {
                if (!validateForm()) {
                    showAlert('الرجاء إكمال جميع الحقول المطلوبة', 'error');
                    return;
                }

                setLoading(true);
                const testData = collectTestData();

                const testId = new URLSearchParams(window.location.search).get('id');
                if (testId) {
                    await window.firebaseDB.updateData(`tests/${testId}`, testData);
                    showAlert('تم تحديث الاختبار بنجاح', 'success');
                } else {
                    await window.firebaseDB.saveData('tests', testData);
                    showAlert('تم إضافة الاختبار بنجاح', 'success');
                }

                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 2000);

            } catch (error) {
                console.error('Error saving test:', error);
                showAlert('حدث خطأ أثناء حفظ الاختبار', 'error');
            } finally {
                setLoading(false);
            }
        }

        // Collect test data from form
        function collectTestData() {
            const title = document.getElementById('testTitle').value.trim();
            const isFree = document.getElementById('testType').value === 'free';
            const image = document.getElementById('imgPreview').src;
            
            // Get questions
            const questions = [];
            document.querySelectorAll('.question-block').forEach((block, index) => {
                const questionText = block.querySelector('.question-text').value.trim();
                const answerInputs = block.querySelectorAll('.answer-text');
                const scoreInputs = block.querySelectorAll('.answer-score');
                const answers = Array.from(answerInputs).map((input, idx) => ({
                    text: input.value.trim(),
                    score: parseInt(scoreInputs[idx].value) || 0
                }));
                if (questionText && answers.length > 0) {
                    questions.push({
                        text: questionText,
                        answers: answers
                    });
                }
            });

            // Get score conditions
            const results = {};
            document.querySelectorAll('.score-condition-row').forEach(row => {
                const min = parseInt(row.querySelector('input[placeholder="من"]').value);
                const max = parseInt(row.querySelector('input[placeholder="إلى"]').value);
                const message = row.querySelector('input[placeholder="الرسالة"]').value.trim();
                if (!isNaN(min) && !isNaN(max) && message) {
                    results[`${min}-${max}`] = message;
                }
            });

            return {
                title,
                isFree,
                image,
                questions,
                results,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            };
        }

        // Validate form
        function validateForm() {
            const title = document.getElementById('testTitle').value.trim();
            const image = document.getElementById('imgPreview').style.display !== 'none';
            const questions = document.querySelectorAll('.question-block').length > 0;

            formValidationState = {
                title: title.length > 0,
                image: image,
                questions: questions
            };

            return Object.values(formValidationState).every(Boolean);
        }

        // Show alert message
        function showAlert(message, type = 'error') {
            const alertDiv = document.getElementById('alert');
            alertDiv.textContent = message;
            alertDiv.className = `alert ${type}`;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 3000);
        }

        // Set loading state
        function setLoading(isLoading) {
            const saveBtn = document.getElementById('saveTestBtn');
            if (isLoading) {
                saveBtn.classList.add('loading');
                saveBtn.disabled = true;
            } else {
                saveBtn.classList.remove('loading');
                saveBtn.disabled = false;
            }
        }

        // Function to add question to UI
        function addQuestionToUI(question, index) {
            const questionsSection = document.getElementById('questionsSection');
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-block';
            questionDiv.id = `question-${index}`;

            let answersHtml = '';
            if (question.answers && Array.isArray(question.answers)) {
                answersHtml = question.answers.map((answer, ansIndex) => `
                    <div class="answer-col">
                        <input type="text" 
                               class="answer-text" 
                               value="${answer.text || answer.answer || answer}" 
                               placeholder="الإجابة ${ansIndex + 1}"
                               data-index="${ansIndex}">
                        <input type="number" 
                               class="answer-score" 
                               value="${question.scores ? question.scores[ansIndex] || 0 : 0}" 
                               placeholder="النقاط"
                               data-index="${ansIndex}">
                    </div>
                `).join('');
            }

            questionDiv.innerHTML = `
                <div class="form-group">
                    <label>السؤال ${index + 1}</label>
                    <input type="text" 
                           class="question-text" 
                           value="${question.text || ''}" 
                           placeholder="أدخل نص السؤال">
                </div>
                <div class="answers-row">
                    ${answersHtml}
                </div>
                <button type="button" class="btn btn-secondary" onclick="removeQuestion(${index})">حذف السؤال</button>
            `;

            questionsSection.appendChild(questionDiv);
        }

        // Function to remove question
        function removeQuestion(index) {
            const questionDiv = document.getElementById(`question-${index}`);
            if (questionDiv) {
                questionDiv.remove();
            }
        }

        // Function to add score condition to UI
        function addScoreConditionToUI(condition) {
            const conditionsList = document.getElementById('scoreConditionsList');
            const conditionDiv = document.createElement('div');
            conditionDiv.className = 'score-condition-row';
            conditionDiv.innerHTML = `
                <input type="number" placeholder="من" min="0" value="${condition.min}" required style="width:70px;">
                <input type="number" placeholder="إلى" min="0" value="${condition.max}" required style="width:70px;">
                <input type="text" placeholder="الرسالة" value="${condition.message}" required>
                <button type="button" class="btn btn-secondary" onclick="this.parentElement.remove()">حذف</button>
            `;
            conditionsList.appendChild(conditionDiv);
        }
    </script>
</body>
</html> 